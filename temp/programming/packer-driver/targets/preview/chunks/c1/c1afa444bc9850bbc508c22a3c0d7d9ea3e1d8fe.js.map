{"version":3,"sources":["file:///E:/Cocos/Project/ROYALTEENPATTI/assets/scripts/commons/uiComponent/RecycleScroll.ts"],"names":["frameLoad","loopTimes","func","frameTime","__index","loop","start","Date","getTime","end","dt","i","e","error","setTimeout","Component","Node","Prefab","ScrollView","UITransform","Vec2","_decorator","instantiate","isValid","log","v2","v3","ccclass","property","menu","RecycleScroll","_numItems","_viewCol","_viewRow","_viewW","_viewH","_itemW","_itemH","_lastPosY","_isInit","_itemsUUIDToIndex","_itemsIndexToNode","_fleshInterval","_fleshCounter","itemList","content","numItems","value","_hideAllItems","_initialize","_updateContentHeight","updateAllItems","onItemRender","index","node","onItemClicked","forEach","item","_updateItem","uuid","scrollToIndexVertical","duration","contentUTF","_getContentUTF","p","height","getComponent","scrollToPercentVertical","getItemDirPos","itemIndex","x","y","Math","floor","spacing","wpos","convertToWorldSpaceAR","parentUTF","parent","itemInViewPos","convertToNodeSpaceAR","horizon","vertical","active","scroll","enabled","viewUTF","width","itemData","itemPrefab","data","position","ceil","surplusW","startPos","cNum","createNum","createFunc","pos","setPosition","on","EventType","TOUCH_END","push","col","row","_getPosInView","lpos","isShow","update","currY","dtY","isDown","itemsLen","length","posInView","viewHalfH","itemHalfH","lastIndex","currIndex"],"mappings":"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","sourcesContent":["import { Component, EPSILON, Node, Prefab, RenderData, ScrollView, StencilManager, UIRenderer, UITransform, Vec2, _decorator, approx, cclegacy, clamp, error, gfx, instantiate, isValid, log, v2, v3 } from \"cc\";\nconst { ccclass, property, menu } = _decorator;\n\n/**\n * 循环+分帧滑动面板\n */\n@ccclass('LevelRender')\n@menu(\"性能优化/RecycleScroll\")\nexport default class RecycleScroll extends Component {\n    /** item预制 */\n    @property(Prefab)\n    itemPrefab: Prefab = null;\n\n    /** item间隔 */\n    @property(Vec2)\n    spacing: Vec2 = v2();\n\n    /** item数量 */\n    private _numItems: number = 0;\n    \n    public get numItems() {\n        return this._numItems;\n    }\n    public set numItems(value: number) {\n        this._numItems = value;\n        this._hideAllItems();\n        this._initialize();\n        this._updateContentHeight();\n        // this.scheduleOnce(() => {\n        // \tthis._initialize();\n        // });\n        this.updateAllItems();\n    }\n\n    /** 视图内显示列数 */\n    private _viewCol: number = 0;\n    /** 视图内显示行数 */\n    private _viewRow: number = 0;\n    /** 视图窗宽 */\n    private _viewW: number = 0;\n    /** 视图窗高 */\n    private _viewH: number = 0;\n    /** item格子宽 */\n    private _itemW: number = 0;\n    /** item格子高 */\n    private _itemH: number = 0;\n    /** content上一次y坐标 */\n    private _lastPosY: number = 0;\n    /** 是否已初始化 */\n    private _isInit: boolean = false;\n    /** item的index */\n    private _itemsUUIDToIndex: { [uuid: string]: number } = {};\n\n    private _itemsIndexToNode: { [index: string]: Node } = {};\n\n    private _fleshInterval: number = 0.2;\n    private _fleshCounter: number = 0;\n\n    /** item列表 */\n    public itemList: Node[] = [];\n    /** item父节点 */\n    public content: UITransform = null;\n\n    /** item刷新回调 */\n    public onItemRender(index: number, node: Node) { }\n    /** item点击回调 */\n    public onItemClicked(index: number, node: Node) { }\n\n    /** 刷新所有item */\n    public updateAllItems() {\n        this.itemList.forEach((item: Node, index: number) => {\n            this._updateItem(this._itemsUUIDToIndex[item.uuid], item);\n        });\n    }\n\n    public scrollToIndexVertical(index: number, duration: number = 0.2) {\n        const contentUTF = this._getContentUTF();\n        const p = (this._itemH * index) / (contentUTF.height - this._viewH);\n        this.node.getComponent(ScrollView).scrollToPercentVertical(1 - p, duration);\n    }\n\n    public getItemDirPos(itemIndex: number) {\n        const x = (itemIndex % this._viewCol) * this._itemW;\n        const y = -Math.floor(itemIndex / this._viewCol) * this._itemH + (this.spacing.y >> 1);\n        const contentUTF = this._getContentUTF();\n        const wpos = contentUTF.convertToWorldSpaceAR(v3(x, y));\n        const parentUTF = this._getContentUTF().node.parent.getComponent(UITransform);\n        const itemInViewPos = parentUTF.convertToNodeSpaceAR(wpos);\n        let horizon = 0;\n        let vertical = 0;\n        horizon = itemInViewPos.x < -this._viewW / 2 ? -1 : (itemInViewPos.x > this._viewW / 2 ? 1 : 0);\n        vertical = itemInViewPos.y < -this._viewH / 2 ? -1 : (itemInViewPos.y > this._viewH / 2 ? 1 : 0);\n        return [horizon, vertical];\n    }\n\n    private _hideAllItems() {\n        this.itemList.forEach((item: Node, index: number) => {\n            item.active = false;\n        });\n    }\n\n    /** 获取content */\n    private _getContentUTF() {\n        return this.node.getComponent(ScrollView).content.getComponent(UITransform);\n    }\n\n    /** 初始化 */\n    private _initialize() {\n        if (this._isInit) return;\n        const scroll = this.node.getComponent(ScrollView);\n        scroll.enabled = false;\n        this._isInit = true;\n        const content = this._getContentUTF();\n        this.content = content;\n        const viewUTF = content.node.parent.getComponent(UITransform);\n        this._viewW = viewUTF.width;\n        this._viewH = viewUTF.height;\n\n        const itemData = this.itemPrefab.data;\n        this._itemW = itemData.width + this.spacing.x;\n        this._itemH = itemData.height + this.spacing.y;\n\n        this._lastPosY = content.node.position.y;\n        this._viewRow = Math.ceil(this._viewH / this._itemH) + 1;\n        this._viewCol = Math.floor(this._viewW / this._itemW);\n        const surplusW = this._viewW - (this._viewCol * this._itemW);\n        const startPos = v3((-this._viewW >> 1) + (this._itemW >> 1) + (surplusW >> 1), -this._itemH >> 1);\n\n        const cNum = this._viewRow * this._viewCol;\n        log(`实例化数量:${cNum}`);\n\n        let createNum = 0;\n        const createFunc = (index: number) => {\n            if (!isValid(content)) return; //异步创建，创建完回来父节点有可能已经被销毁\n            const item = instantiate(this.itemPrefab);\n            item.parent = content.node;\n            const x = (index % this._viewCol) * this._itemW;\n            const y = -Math.floor(index / this._viewCol) * this._itemH + (this.spacing.y >> 1);\n            const pos = v3(x + startPos.x, y + startPos.y);\n            item.setPosition(pos);\n            item.on(Node.EventType.TOUCH_END, () => {\n                this.onItemClicked(this._itemsUUIDToIndex[item.uuid], item);\n            }, this);\n            this.itemList.push(item);\n\n            this._updateItem(index, item);\n\n            this._itemsUUIDToIndex[item.uuid] = index;\n            this._itemsIndexToNode[index] = item;\n\n            createNum++;\n            if (createNum == cNum) {\n                scroll.enabled = true;\n            }\n        }\n        /** 分帧创建item */\n        frameLoad(cNum, createFunc);\n    }\n\n    /** 更新centent高度 */\n    private _updateContentHeight() {\n        const content = this._getContentUTF();\n        const col = Math.floor(this._viewW / this._itemW);\n        const row = Math.ceil(this.numItems / col);\n        content.height = row * (this.itemPrefab.data.height + this.spacing.y) - (this.spacing.y);\n    }\n\n    /** 获取item在view坐标系的对标 */\n    private _getPosInView(item: Node) {\n        const content = this._getContentUTF();\n        const viewUTF = content.node.parent.getComponent(UITransform);\n        const wpos = content.convertToWorldSpaceAR(item.position);\n        const lpos = viewUTF.convertToNodeSpaceAR(wpos);\n        return lpos;\n    }\n\n    /** 更新item */\n    private _updateItem(index: number, item: Node) {\n        const isShow = index >= 0 && index < this.numItems;\n        item.active = isShow;\n        if (isShow) {\n            this.onItemRender(index, item);\n        }\n    }\n\n    public update(dt: number) {\n        const content = this._getContentUTF();\n        const currY = content.node.position.y;\n        const dtY = currY - this._lastPosY;\n        this._lastPosY = currY;\n        // this._fleshCounter += dt;\n        // if (dtY == 0 && this._fleshCounter < this._fleshInterval) return;\n        // this._fleshCounter = 0;\n        const isDown = dtY < 0;\n        const itemsLen = this.itemList.length;\n        for (let i = 0; i < itemsLen; ++i) {\n            const item = this.itemList[i];\n            const posInView = this._getPosInView(item);\n            const viewHalfH = this._viewH >> 1;\n            const itemHalfH = this._itemH >> 1;\n            const lastIndex = this._itemsUUIDToIndex[item.uuid];\n            let currIndex = lastIndex;\n            if (!isDown) {\n                if (posInView.y >= viewHalfH + itemHalfH) {\n                    item.setPosition(v3(item.position.x, item.position.y - (this._viewRow * this._itemH)));\n                    currIndex = lastIndex + itemsLen;\n                }\n            } else {\n                if (posInView.y <= -(viewHalfH + itemHalfH)) {\n                    item.setPosition(v3(item.position.x, item.position.y + (this._viewRow * this._itemH)));\n                    currIndex = lastIndex - itemsLen;\n                }\n            }\n            if (currIndex != lastIndex) {\n                this._updateItem(currIndex, item);\n            }\n            this._itemsUUIDToIndex[item.uuid] = currIndex;\n            this._itemsIndexToNode[currIndex] = item;\n        }\n    }\n}\n\n/** 分帧执行 */\nfunction frameLoad(loopTimes: number, func: Function, frameTime: number = 16, __index: number = 0) {\n    let loop = loopTimes;\n    let start = new Date().getTime();\n    let end = 0;\n    let dt = 0;\n    for (let i = 0; i < loop; ++i) {\n        if (__index >= loop) {\n            break;\n        }\n        try {\n            func && func(__index);\n        } catch (e) {\n            error(e);\n        }\n        __index++;\n        end = new Date().getTime();\n        dt = end - start;\n        if (dt > frameTime) {\n            setTimeout(() => {\n                frameLoad(loop, func, frameTime, __index);\n            }, 10);\n            break;\n        }\n    }\n}\n"]}